using business_foundation_lib.xq_thriftlib_config;
using IDLAutoGenerated.Util;
using lib.xqclient_base.thriftapi_mediation.Interface;
using Manage.Applications.ViewModels;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.ComponentModel.Composition;
using System.Linq;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using System.Waf.Applications;
using xueqiao.trade.hosting;
using xueqiao.trade.hosting.asset.thriftapi;
using XueQiaoFoundation.Shared.Helper;
using XueQiaoFoundation.Shared.Interface;
using XueQiaoFoundation.UI.Components.ListPager;
using XueQiaoFoundation.UI.Components.ListPager.ViewModels;
using XueQiaoWaf.LoginUserManage.Interfaces.Applications;

namespace Manage.Applications.Controllers
{
    [Export, PartCreationPolicy(CreationPolicy.NonShared)]
    internal class SubAccountInOutFundHistoryPageController : IController
    {
        private const int ListRequestPageSize = 50;

        private readonly ILoginDataService loginDataService;
        private readonly SimplePagerViewModel pagerViewModel;

        private readonly DelegateCommand goBackCmd;
        private readonly DelegateCommand goJumpPageCmd;

        [ImportingConstructor]
        public SubAccountInOutFundHistoryPageController(ILoginDataService loginDataService,
            SubAccountInOutFundHistoryPageModel pageViewModel,
            SimplePagerViewModel pagerViewModel)
        {
            this.loginDataService = loginDataService;
            this.PageViewModel = pageViewModel;
            this.pagerViewModel = pagerViewModel;

            goBackCmd = new DelegateCommand(() => this.GoBackHandler?.Invoke(this));
            goJumpPageCmd = new DelegateCommand(GoJumpPage);
        }

        /// <summary>
        /// 目标操作账户
        /// </summary>
        public HostingSubAccount TargetSubAccount { get; set; }

        /// <summary>
        /// 后退处理
        /// </summary>
        public Action<SubAccountInOutFundHistoryPageController> GoBackHandler { get; set; }

        public SubAccountInOutFundHistoryPageModel PageViewModel { get; private set; }

        public void Initialize()
        {
            if (TargetSubAccount == null) throw new ArgumentNullException("SubAccount");

            PageViewModel.SubAccount = TargetSubAccount;
            PageViewModel.GoBackCmd = goBackCmd;

            PageViewModel.PagerContentView = pagerViewModel.View;
            pagerViewModel.GoJumpPageCmd = goJumpPageCmd;
        }

        public void Run()
        {
            RefreshFirstPageInOutFundRecords();
        }

        public void Shutdown()
        {
            GoBackHandler = null;
        }

        private void GoJumpPage(object obj)
        {
            var pagingCtrl = pagerViewModel.PagingController as PagingController;
            if (pagingCtrl == null) return;
            try
            {
                var page = System.Convert.ToInt32(obj);
                if (page < 0 || page > pagingCtrl.PageCount)
                {
                    return;
                }
                pagingCtrl.CurrentPage = page;
            }
            catch (Exception)
            {

            }
        }

        private void PagingControllerPropertyChanged(object sender, PropertyChangedEventArgs e)
        {
            var pagingCtrl = sender as PagingController;
            if (pagingCtrl == null) return;
            if (e.PropertyName == nameof(PagingController.CurrentPage))
            {
                var reqPage = pagingCtrl.CurrentPage - 1;
                if (reqPage < 0) reqPage = 0;
                if (reqPage >= pagingCtrl.PageCount) return;

                LoadInOutFundRecords(reqPage, ListRequestPageSize, resp =>
                {
                    var respCorrentResult = resp?.CorrectResult;
                    DispatcherHelper.CheckBeginInvokeOnUI(() =>
                    {
                        if (resp == null || resp.SourceException != null || respCorrentResult == null)
                        {
                            // error handle
                            return;
                        }

                        // 更新列表数据
                        PageViewModel.InOutFundHistoryItems.Clear();
                        PageViewModel.InOutFundHistoryItems.AddRange(respCorrentResult.Page);
                    });
                });
            }
        }

        private void RefreshFirstPageInOutFundRecords()
        {
            LoadInOutFundRecords(0, ListRequestPageSize, resp =>
            {
                var respCorrentResult = resp?.CorrectResult;
                DispatcherHelper.CheckBeginInvokeOnUI(() =>
                {
                    if (resp == null || resp.SourceException != null || respCorrentResult == null)
                    {
                        // error handle
                        return;
                    }

                    // 更新翻页控制器
                    var oldPagingController = pagerViewModel.PagingController;
                    if (oldPagingController != null)
                    {
                        PropertyChangedEventManager.RemoveHandler(oldPagingController, PagingControllerPropertyChanged, "");
                    }
                    pagerViewModel.PagingController = new PagingController(respCorrentResult.Total, ListRequestPageSize);
                    PropertyChangedEventManager.AddHandler(pagerViewModel.PagingController, PagingControllerPropertyChanged, "");

                    // 更新列表数据
                    PageViewModel.InOutFundHistoryItems.Clear();
                    PageViewModel.InOutFundHistoryItems.AddRange(respCorrentResult.Page);
                });
            });
        }

        private void LoadInOutFundRecords(int pageIndex, int pageSize,
            Action<IInterfaceInteractResponse<HostingSubAccountMoneyRecordPage>> handler)
        {
            var landingInfo = loginDataService.ProxyLoginResp?.HostingSession?.HostingSession2LandingInfo();
            if (landingInfo == null)
            {
                handler?.Invoke(null);
                return;
            }

            var option = new ReqMoneyRecordOption { SubAccountId = TargetSubAccount.SubAccountId };
            var pageOption = new IndexedPageOption
            {
                NeedTotalCount = true,
                PageIndex = pageIndex,
                PageSize = pageSize,
            };

            var task = XqThriftLibConfigurationManager.SharedInstance
                .TradeHostingTerminalAoHttpStub
                .getHostingSubAccountMoneyRecordAsync(landingInfo, option, pageOption, CancellationToken.None);
            task.ContinueWith(t =>
            {
                handler?.Invoke(t.Result);
            });
        }
    }
}
