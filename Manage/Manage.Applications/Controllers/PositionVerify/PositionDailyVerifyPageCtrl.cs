using business_foundation_lib.xq_thriftlib_config;
using IDLAutoGenerated.Util;
using Manage.Applications.DataModels;
using Manage.Applications.ViewModels;
using System;
using System.Collections.Generic;
using System.ComponentModel.Composition;
using System.Linq;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using System.Waf.Applications;
using Thrift.Protocol;
using xueqiao.trade.hosting.position.adjust.thriftapi;
using xueqiao.trade.hosting.terminal.ao;
using XueQiaoFoundation.BusinessResources.DataModels;
using XueQiaoFoundation.BusinessResources.Models;
using XueQiaoFoundation.Interfaces.Applications;
using XueQiaoFoundation.Interfaces.Helper;
using XueQiaoFoundation.Shared.Helper;
using XueQiaoFoundation.Shared.Interface;
using XueQiaoWaf.LoginUserManage.Interfaces.Applications;

namespace Manage.Applications.Controllers
{
    [Export, PartCreationPolicy(CreationPolicy.NonShared)]
    internal class PositionDailyVerifyPageCtrl : IController
    {
        private readonly PositionDailyVerifyPageModel contentVM;
        private readonly ILoginDataService loginDataService;
        private readonly IContractItemTreeQueryController contractItemTreeQueryController;
        private readonly SettlementBillsCompareViewCtrl settlementBillsCompareViewCtrl;
        private readonly XqTradeItemsCompareViewCtrl xqTradeItemsCompareViewCtrl;
        private readonly PositionVerifyTradeInputAreaViewCtrl tradeInputAreaViewCtrl;
        private readonly ExportFactory<UpdateDailyPositionVerifyStatusDialogCtrl> verifyStatusDialogCtrlFactory;

        private readonly SettlementCompareItem settlementCompareItem = new SettlementCompareItem();

        private readonly DelegateCommand pageGoBackCmd;
        private readonly DelegateCommand toUpdateVerifyStatusCmd;

        #region TEST bills content
        private const string TEST_BILLS_CONTENT = @"                                        金瑞期货股份有限公司                                        
                                                                    制表时间 Creation Date：20180806
----------------------------------------------------------------------------------------------------
                             交易结算单(盯市) Settlement Statement(MTM)                             
客户号 Client ID：  180597          客户名称 Client Name：黎洁松
日期 Date：20180806




                   资金状况  币种：人民币  Account Summary  Currency：CNY 
----------------------------------------------------------------------------------------------------
期初结存 Balance b/f：                  6120487.26  基础保证金 Initial Margin：                 0.00
出 入 金 Deposit/Withdrawal：                 0.00  期末结存 Balance c/f：                6057987.24
平仓盈亏 Realized P/L：                  -16885.00  质 押 金 Pledge Amount：                    0.00
持仓盯市盈亏 MTM P/L：                   -45115.00  客户权益 Client Equity：：            6057987.24
期权执行盈亏 Exercise P/L：                   0.00  货币质押保证金占用 FX Pledge Occ.：         0.00
手 续 费 Commission：                       500.02  保证金占用 Margin Occupied：          2544527.95
行权手续费 Exercise Fee：                     0.00  交割保证金 Delivery Margin：                0.00
交割手续费 Delivery Fee：                     0.00  多头期权市值 Market value(long)：           0.00
货币质入 New FX Pledge：                      0.00  空头期权市值 Market value(short)：          0.00
货币质出 FX Redemption：                      0.00  市值权益 Market value(equity)：       6057987.24
质押变化金额 Chg in Pledge Amt：              0.00  可用资金 Fund Avail.：                3513459.29
权利金收入 Premium received：                 0.00  风 险 度 Risk Degree：                      0.42
权利金支出 Premium paid：                     0.00  应追加资金 Margin Call：                    0.00
货币质押变化金额 Chg in FX Pledge:            0.00

                                                              成交记录 Transaction Record 
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
|成交日期| 交易所 |       品种       |      合约      |买/卖|   投/保    |  成交价  | 手数 |   成交额   |       开平       |  手续费  |  平仓盈亏  |     权利金收支      |  成交序号  |
|  Date  |Exchange|     Product      |   Instrument   | B/S |    S/H     |   Price  | Lots |  Turnover  |       O/C        |   Fee    |Realized P/L|Premium Received/Paid|  Trans.No. |
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
|20180806|大商所  |黄玉米            |     c1809      |买   |投          |  1778.000|     2|    35560.00|开                |      1.26|        0.00|                 0.00|10133817    |
|20180806|大商所  |黄玉米            |     c1809      |买   |投          |  1778.000|     2|    35560.00|开                |      1.26|        0.00|                 0.00|10133818    |
|20180806|大商所  |黄玉米            |     c1809      |   卖|投          |  1779.000|     4|    71160.00|  平              |      2.52|       40.00|                 0.00|10141037    |
|20180806|大商所  |聚氯乙烯          |     v1809      |买   |投          |  7170.000|     1|    35850.00|开                |      2.10|        0.00|                 0.00|30671585    |
|20180806|大商所  |聚氯乙烯          |     v1809      |买   |投          |  7170.000|     1|    35850.00|开                |      2.10|        0.00|                 0.00|30671973    |
|20180806|大商所  |聚氯乙烯          |     v1809      |买   |投          |  7130.000|     1|    35650.00|开                |      2.10|        0.00|                 0.00|30675357    |
|20180806|大商所  |聚氯乙烯          |     v1809      |买   |投          |  7130.000|     1|    35650.00|开                |      2.10|        0.00|                 0.00|30675458    |
|20180806|大商所  |聚氯乙烯          |     v1809      |买   |投          |  7130.000|     1|    35650.00|开                |      2.10|        0.00|                 0.00|30675609    |
|20180806|大商所  |聚氯乙烯          |     v1901      |   卖|投          |  7110.000|     1|    35550.00|开                |      2.10|        0.00|                 0.00|30671582    |
|20180806|大商所  |聚氯乙烯          |     v1901      |   卖|投          |  7110.000|     1|    35550.00|开                |      2.10|        0.00|                 0.00|30671922    |
|20180806|大商所  |聚氯乙烯          |     v1901      |   卖|投          |  7080.000|     1|    35400.00|开                |      2.10|        0.00|                 0.00|30675353    |
|20180806|大商所  |聚氯乙烯          |     v1901      |   卖|投          |  7080.000|     1|    35400.00|开                |      2.10|        0.00|                 0.00|30675455    |
|20180806|大商所  |聚氯乙烯          |     v1901      |   卖|投          |  7080.000|     1|    35400.00|开                |      2.10|        0.00|                 0.00|30675587    |
|20180806|上期所  |铜                |     cu1809     |买   |投          | 49400.000|     2|   494000.00|  平              |     25.94|    -1900.00|                 0.00|00681680    |
|20180806|上期所  |铜                |     cu1809     |买   |投          | 49410.000|     1|   247050.00|  平              |     12.97|    -1000.00|                 0.00|00681743    |
|20180806|上期所  |铜                |     cu1809     |买   |投          | 49410.000|     1|   247050.00|  平              |     12.97|    -1000.00|                 0.00|00681744    |
|20180806|上期所  |锌                |     zn1809     |买   |投          | 21615.000|     2|   216150.00|  平              |      6.30|    -1700.00|                 0.00|00006779    |
|20180806|上期所  |锌                |     zn1809     |买   |投          | 21615.000|     1|   108075.00|  平              |      3.15|     -850.00|                 0.00|00006780    |
|20180806|上期所  |锌                |     zn1809     |买   |投          | 21615.000|     1|   108075.00|  平              |      3.15|     -850.00|                 0.00|00006781    |
|20180806|上期所  |锌                |     zn1809     |买   |投          | 21615.000|     1|   108075.00|  平              |      3.15|     -850.00|                 0.00|00006782    |
|20180806|上期所  |锌                |     zn1809     |买   |投          | 21610.000|     3|   324150.00|  平              |      9.45|    -2475.00|                 0.00|00021677    |
|20180806|上期所  |锌                |     zn1809     |买   |投          | 21610.000|     2|   216100.00|  平              |      6.30|    -1650.00|                 0.00|00021678    |
|20180806|上期所  |锌                |     zn1809     |买   |投          | 21605.000|     5|   540125.00|  平              |     15.75|    -4000.00|                 0.00|00022756    |
|20180806|上期所  |锌                |     zn1809     |买   |投          | 21675.000|     1|   108375.00|  平              |      3.15|    -1150.00|                 0.00|00049835    |
|20180806|上期所  |锌                |     zn1809     |买   |投          | 21675.000|     1|   108375.00|开                |      3.15|        0.00|                 0.00|00049845    |
|20180806|上期所  |锌                |     zn1809     |买   |投          | 21675.000|     1|   108375.00|开                |      3.15|        0.00|                 0.00|00049846    |
|20180806|上期所  |锌                |     zn1809     |买   |投          | 21670.000|     1|   108350.00|开                |      3.15|        0.00|                 0.00|00050083    |
|20180806|上期所  |锌                |     zn1809     |买   |投          | 21670.000|     1|   108350.00|开                |      3.15|        0.00|                 0.00|00050084    |
|20180806|上期所  |锌                |     zn1809     |   卖|投          | 21770.000|     4|   435400.00|平今              |     63.00|     1950.00|                 0.00|00066668    |
|20180806|上期所  |锌                |     zn1809     |   卖|投          | 21770.000|     1|   108850.00|开                |      3.15|        0.00|                 0.00|00066675    |
|20180806|上期所  |锌                |     zn1809     |   卖|投          | 21725.000|     4|   434500.00|开                |     12.60|        0.00|                 0.00|00082534    |
|20180806|上期所  |锌                |     zn1809     |   卖|投          | 21725.000|     1|   108625.00|开                |      3.15|        0.00|                 0.00|00082535    |
|20180806|上期所  |锌                |     zn1809     |   卖|投          | 21815.000|     1|   109075.00|开                |      3.15|        0.00|                 0.00|00097091    |
|20180806|上期所  |锌                |     zn1809     |   卖|投          | 21815.000|     4|   436300.00|开                |     12.60|        0.00|                 0.00|00097092    |
|20180806|上期所  |锌                |     zn1809     |买   |投          | 21725.000|     5|   543125.00|平今              |     78.75|      225.00|                 0.00|00149832    |
|20180806|上期所  |锌                |     zn1809     |买   |投          | 21685.000|     1|   108425.00|平今              |     15.75|      200.00|                 0.00|00430416    |
|20180806|上期所  |锌                |     zn1809     |买   |投          | 21685.000|     4|   433700.00|平今              |     63.00|     2600.00|                 0.00|00430417    |
|20180806|上期所  |锌                |     zn1809     |买   |投          | 21700.000|     1|   108500.00|开                |      3.15|        0.00|                 0.00|00470812    |
|20180806|上期所  |锌                |     zn1809     |买   |投          | 21700.000|     1|   108500.00|开                |      3.15|        0.00|                 0.00|00470813    |
|20180806|上期所  |锌                |     zn1809     |买   |投          | 21700.000|     2|   217000.00|开                |      6.30|        0.00|                 0.00|00470814    |
|20180806|上期所  |锌                |     zn1809     |买   |投          | 21700.000|     1|   108500.00|平今              |     15.75|      575.00|                 0.00|00470815    |
|20180806|上期所  |锌                |     zn1809     |   卖|投          | 21665.000|     1|   108325.00|平今              |     15.75|     -175.00|                 0.00|01081777    |
|20180806|上期所  |锌                |     zn1809     |   卖|投          | 21575.000|     1|   107875.00|平今              |     15.75|     -625.00|                 0.00|01221342    |
|20180806|上期所  |锌                |     zn1809     |   卖|投          | 21480.000|     1|   107400.00|平今              |     15.75|    -1100.00|                 0.00|01858178    |
|20180806|上期所  |锌                |     zn1809     |   卖|投          | 21465.000|     1|   107325.00|平今              |     15.75|    -1175.00|                 0.00|01876023    |
|20180806|上期所  |锌                |     zn1811     |买   |投          | 21350.000|     1|   106750.00|  平              |      3.15|    -1100.00|                 0.00|01081179    |
|20180806|上期所  |锌                |     zn1811     |买   |投          | 21275.000|     1|   106375.00|  平              |      3.15|     -725.00|                 0.00|01220898    |
|20180806|上期所  |锌                |     zn1812     |买   |投          | 21040.000|     1|   105200.00|  平              |      3.15|     -100.00|                 0.00|01858155    |
|20180806|上期所  |锌                |     zn1812     |买   |投          | 21030.000|     1|   105150.00|  平              |      3.15|      -50.00|                 0.00|01875904    |
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
|共  49条|        |                  |                      |            |          |    80|  7763805.00|                  |    500.02|   -16885.00|                 0.00|            |
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
能源中心---INE  上期所---SHFE   中金所---CFFEX  大商所---DCE   郑商所---CZCE
买---Buy   卖---Sell
投---Speculation  保---Hedge  套---Arbitrage 般---General
开---Open 平---Close 平今---Close Today 强平---Forced Liquidation 平昨---Close Prev. 强减---Forced Reduction 本地强平---Local Forced Liquidation 

                                                         平仓明细 Position Closed 
----------------------------------------------------------------------------------------------------------------------------------------------------------------------
| 平仓日期 | 交易所 |       品种       |      合约      |开仓日期 |买/卖|   手数   |     开仓价    |     昨结算     |   成交价   |  平仓盈亏  |     权利金收支      |
|Close Date|Exchange|      Product     |   Instrument   |Open Date| B/S |   Lots   |Pos. Open Price|   Prev. Sttl   |Trans. Price|Realized P/L|Premium Received/Paid|
----------------------------------------------------------------------------------------------------------------------------------------------------------------------
|20180806  |大商所  |黄玉米            |c1809           |20180806 |   卖|         2|       1778.000|        1780.000|    1779.000|       20.00|                 0.000|
|20180806  |大商所  |黄玉米            |c1809           |20180806 |   卖|         2|       1778.000|        1780.000|    1779.000|       20.00|                 0.000|
|20180806  |上期所  |铜                |cu1809          |20180713 |买   |         1|      48820.000|       49210.000|   49400.000|     -950.00|                 0.000|
|20180806  |上期所  |铜                |cu1809          |20180713 |买   |         1|      48820.000|       49210.000|   49400.000|     -950.00|                 0.000|
|20180806  |上期所  |铜                |cu1809          |20180713 |买   |         1|      48820.000|       49210.000|   49410.000|    -1000.00|                 0.000|
|20180806  |上期所  |铜                |cu1809          |20180713 |买   |         1|      48820.000|       49210.000|   49410.000|    -1000.00|                 0.000|
|20180806  |上期所  |锌                |zn1809          |20180802 |买   |         1|      21415.000|       21445.000|   21615.000|     -850.00|                 0.000|
|20180806  |上期所  |锌                |zn1809          |20180802 |买   |         1|      21375.000|       21445.000|   21615.000|     -850.00|                 0.000|
|20180806  |上期所  |锌                |zn1809          |20180802 |买   |         1|      21375.000|       21445.000|   21615.000|     -850.00|                 0.000|
|20180806  |上期所  |锌                |zn1809          |20180802 |买   |         1|      21375.000|       21445.000|   21615.000|     -850.00|                 0.000|
|20180806  |上期所  |锌                |zn1809          |20180802 |买   |         1|      21375.000|       21445.000|   21615.000|     -850.00|                 0.000|
|20180806  |上期所  |锌                |zn1809          |20180802 |买   |         2|      21370.000|       21445.000|   21610.000|    -1650.00|                 0.000|
|20180806  |上期所  |锌                |zn1809          |20180802 |买   |         1|      21375.000|       21445.000|   21610.000|     -825.00|                 0.000|
|20180806  |上期所  |锌                |zn1809          |20180802 |买   |         2|      21370.000|       21445.000|   21610.000|    -1650.00|                 0.000|
|20180806  |上期所  |锌                |zn1809          |20180802 |买   |         1|      21395.000|       21445.000|   21605.000|     -800.00|                 0.000|
|20180806  |上期所  |锌                |zn1809          |20180802 |买   |         1|      21370.000|       21445.000|   21605.000|     -800.00|                 0.000|
|20180806  |上期所  |锌                |zn1809          |20180802 |买   |         3|      21395.000|       21445.000|   21605.000|    -2400.00|                 0.000|
|20180806  |上期所  |锌                |zn1809          |20180802 |买   |         1|      21395.000|       21445.000|   21675.000|    -1150.00|                 0.000|
|20180806  |上期所  |锌                |zn1809          |20180806 |   卖|         1|      21670.000|       21445.000|   21770.000|      500.00|                 0.000|
|20180806  |上期所  |锌                |zn1809          |20180806 |   卖|         1|      21670.000|       21445.000|   21770.000|      500.00|                 0.000|
|20180806  |上期所  |锌                |zn1809          |20180806 |   卖|         1|      21675.000|       21445.000|   21770.000|      475.00|                 0.000|
|20180806  |上期所  |锌                |zn1809          |20180806 |   卖|         1|      21675.000|       21445.000|   21770.000|      475.00|                 0.000|
|20180806  |上期所  |锌                |zn1809          |20180806 |买   |         4|      21725.000|       21445.000|   21725.000|        0.00|                 0.000|
|20180806  |上期所  |锌                |zn1809          |20180806 |买   |         1|      21770.000|       21445.000|   21725.000|      225.00|                 0.000|
|20180806  |上期所  |锌                |zn1809          |20180806 |买   |         1|      21725.000|       21445.000|   21685.000|      200.00|                 0.000|
|20180806  |上期所  |锌                |zn1809          |20180806 |买   |         1|      21815.000|       21445.000|   21685.000|      650.00|                 0.000|
|20180806  |上期所  |锌                |zn1809          |20180806 |买   |         3|      21815.000|       21445.000|   21685.000|     1950.00|                 0.000|
|20180806  |上期所  |锌                |zn1809          |20180806 |买   |         1|      21815.000|       21445.000|   21700.000|      575.00|                 0.000|
|20180806  |上期所  |锌                |zn1809          |20180806 |   卖|         1|      21700.000|       21445.000|   21665.000|     -175.00|                 0.000|
|20180806  |上期所  |锌                |zn1809          |20180806 |   卖|         1|      21700.000|       21445.000|   21575.000|     -625.00|                 0.000|
|20180806  |上期所  |锌                |zn1809          |20180806 |   卖|         1|      21700.000|       21445.000|   21480.000|    -1100.00|                 0.000|
|20180806  |上期所  |锌                |zn1809          |20180806 |   卖|         1|      21700.000|       21445.000|   21465.000|    -1175.00|                 0.000|
|20180806  |上期所  |锌                |zn1811          |20180723 |买   |         1|      21200.000|       21130.000|   21350.000|    -1100.00|                 0.000|
|20180806  |上期所  |锌                |zn1811          |20180723 |买   |         1|      21200.000|       21130.000|   21275.000|     -725.00|                 0.000|
|20180806  |上期所  |锌                |zn1812          |20180725 |买   |         1|      20975.000|       21020.000|   21040.000|     -100.00|                 0.000|
|20180806  |上期所  |锌                |zn1812          |20180725 |买   |         1|      20980.000|       21020.000|   21030.000|      -50.00|                 0.000|
----------------------------------------------------------------------------------------------------------------------------------------------------------------------
|共    36条|        |                  |                |         |     |        47|               |                |            |   -16885.00|                  0.00|
----------------------------------------------------------------------------------------------------------------------------------------------------------------------
能源中心---INE  上期所---SHFE   中金所---CFFEX  大商所---DCE   郑商所---CZCE  
买---Buy   卖---Sell 

                                              持仓明细 Positions Detail
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
| 交易所 |       品种       |      合约      |开仓日期 |   投/保    |买/卖|持仓量 |    开仓价     |     昨结算     |     结算价     |  浮动盈亏  |  盯市盈亏 |  保证金   |       期权市值       |
|Exchange|     Product      |   Instrument   |Open Date|    S/H     | B/S |Positon|Pos. Open Price|   Prev. Sttl   |Settlement Price| Accum. P/L |  MTM P/L  |  Margin   | Market Value(Options)|
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
| 大商所 |      黄玉米      |     c1901      | 20180706|投          |   卖|      1|       1844.000|        1849.000|        1864.000|     -200.00|    -150.00|    1304.80|                  0.00|
| 大商所 |      黄玉米      |     c1901      | 20180718|投          |买   |      5|       1863.000|        1849.000|        1864.000|       50.00|     750.00|    6524.00|                  0.00|
| 大商所 |      黄玉米      |     c1901      | 20180727|投          |买   |      1|       1835.000|        1849.000|        1864.000|      290.00|     150.00|    1304.80|                  0.00|
| 大商所 |       鸡蛋       |     jd1901     | 20180719|投          |买   |      1|       3734.000|        3749.000|        3769.000|      350.00|     200.00|    3015.20|                  0.00|
| 大商所 |       鸡蛋       |     jd1901     | 20180720|投          |买   |      1|       3757.000|        3749.000|        3769.000|      120.00|     200.00|    3015.20|                  0.00|
| 大商所 |       鸡蛋       |     jd1901     | 20180803|投          |   卖|      1|       3792.000|        3749.000|        3769.000|      230.00|    -200.00|    3015.20|                  0.00|
| 大商所 |       鸡蛋       |     jd1901     | 20180803|投          |   卖|      1|       3790.000|        3749.000|        3769.000|      210.00|    -200.00|    3015.20|                  0.00|
| 大商所 |     聚氯乙烯     |     v1809      | 20180806|投          |买   |      1|       7170.000|        7180.000|        7185.000|       75.00|      75.00|    2514.75|                  0.00|
| 大商所 |     聚氯乙烯     |     v1809      | 20180806|投          |买   |      1|       7170.000|        7180.000|        7185.000|       75.00|      75.00|    2514.75|                  0.00|
| 大商所 |     聚氯乙烯     |     v1809      | 20180806|投          |买   |      1|       7130.000|        7180.000|        7185.000|      275.00|     275.00|    2514.75|                  0.00|
| 大商所 |     聚氯乙烯     |     v1809      | 20180806|投          |买   |      1|       7130.000|        7180.000|        7185.000|      275.00|     275.00|    2514.75|                  0.00|
| 大商所 |     聚氯乙烯     |     v1809      | 20180806|投          |买   |      1|       7130.000|        7180.000|        7185.000|      275.00|     275.00|    2514.75|                  0.00|
| 大商所 |     聚氯乙烯     |     v1901      | 20180806|投          |   卖|      1|       7110.000|        7105.000|        7120.000|      -50.00|     -50.00|    2492.00|                  0.00|
| 大商所 |     聚氯乙烯     |     v1901      | 20180806|投          |   卖|      1|       7110.000|        7105.000|        7120.000|      -50.00|     -50.00|    2492.00|                  0.00|
| 大商所 |     聚氯乙烯     |     v1901      | 20180806|投          |   卖|      1|       7080.000|        7105.000|        7120.000|     -200.00|    -200.00|    2492.00|                  0.00|
| 大商所 |     聚氯乙烯     |     v1901      | 20180806|投          |   卖|      1|       7080.000|        7105.000|        7120.000|     -200.00|    -200.00|    2492.00|                  0.00|
| 大商所 |     聚氯乙烯     |     v1901      | 20180806|投          |   卖|      1|       7080.000|        7105.000|        7120.000|     -200.00|    -200.00|    2492.00|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180711|投          |买   |      1|        272.700|         270.400|         270.450|    -2250.00|      50.00|   13522.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180718|投          |买   |      1|        269.100|         270.400|         270.450|     1350.00|      50.00|   13522.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180718|投          |买   |      1|        269.100|         270.400|         270.450|     1350.00|      50.00|   13522.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180718|投          |买   |      1|        269.100|         270.400|         270.450|     1350.00|      50.00|   13522.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180718|投          |买   |      3|        269.100|         270.400|         270.450|     4050.00|     150.00|   40567.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180718|投          |买   |      1|        269.000|         270.400|         270.450|     1450.00|      50.00|   13522.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180718|投          |买   |      1|        269.000|         270.400|         270.450|     1450.00|      50.00|   13522.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180718|投          |买   |      1|        269.000|         270.400|         270.450|     1450.00|      50.00|   13522.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180718|投          |买   |      3|        268.850|         270.400|         270.450|     4800.00|     150.00|   40567.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180719|投          |买   |      2|        269.700|         270.400|         270.450|     1500.00|     100.00|   27045.00|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180719|投          |买   |      1|        269.700|         270.400|         270.450|      750.00|      50.00|   13522.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180719|投          |买   |      3|        269.700|         270.400|         270.450|     2250.00|     150.00|   40567.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180719|投          |买   |      3|        269.850|         270.400|         270.450|     1800.00|     150.00|   40567.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180719|投          |买   |      1|        269.650|         270.400|         270.450|      800.00|      50.00|   13522.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180719|投          |买   |      2|        269.700|         270.400|         270.450|     1500.00|     100.00|   27045.00|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180719|投          |买   |      3|        269.700|         270.400|         270.450|     2250.00|     150.00|   40567.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180719|投          |买   |      3|        269.900|         270.400|         270.450|     1650.00|     150.00|   40567.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180719|投          |买   |      3|        269.600|         270.400|         270.450|     2550.00|     150.00|   40567.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180719|投          |买   |      3|        269.600|         270.400|         270.450|     2550.00|     150.00|   40567.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180719|投          |买   |      3|        269.600|         270.400|         270.450|     2550.00|     150.00|   40567.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180719|投          |买   |      3|        269.600|         270.400|         270.450|     2550.00|     150.00|   40567.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180719|投          |买   |      1|        269.800|         270.400|         270.450|      650.00|      50.00|   13522.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180720|投          |买   |      2|        270.950|         270.400|         270.450|    -1000.00|     100.00|   27045.00|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180720|投          |买   |      1|        270.950|         270.400|         270.450|     -500.00|      50.00|   13522.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180720|投          |买   |      1|        270.350|         270.400|         270.450|      100.00|      50.00|   13522.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180720|投          |买   |      1|        270.350|         270.400|         270.450|      100.00|      50.00|   13522.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180720|投          |买   |      1|        270.350|         270.400|         270.450|      100.00|      50.00|   13522.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180720|投          |买   |      1|        270.600|         270.400|         270.450|     -150.00|      50.00|   13522.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180720|投          |买   |      2|        270.600|         270.400|         270.450|     -300.00|     100.00|   27045.00|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180720|投          |买   |      3|        270.600|         270.400|         270.450|     -450.00|     150.00|   40567.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180720|投          |买   |      1|        270.750|         270.400|         270.450|     -300.00|      50.00|   13522.50|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180720|投          |买   |      2|        270.750|         270.400|         270.450|     -600.00|     100.00|   27045.00|                  0.00|
| 上期所 |       黄金       |     au1812     | 20180720|投          |买   |      3|        270.750|         270.400|         270.450|     -900.00|     150.00|   40567.50|                  0.00|
| 上期所 |        镍        |     ni1809     | 20180716|投          |   卖|      4|     110720.000|      109810.000|      109950.000|     3080.00|    -560.00|   43980.00|                  0.00|
| 上期所 |        镍        |     ni1809     | 20180717|投          |   卖|      1|     109660.000|      109810.000|      109950.000|     -290.00|    -140.00|   10995.00|                  0.00|
| 上期所 |        镍        |     ni1809     | 20180717|投          |   卖|      5|     109650.000|      109810.000|      109950.000|    -1500.00|    -700.00|   54975.00|                  0.00|
| 上期所 |        镍        |     ni1809     | 20180718|投          |   卖|      1|     108730.000|      109810.000|      109950.000|    -1220.00|    -140.00|   10995.00|                  0.00|
| 上期所 |        镍        |     ni1809     | 20180718|投          |   卖|      1|     108720.000|      109810.000|      109950.000|    -1230.00|    -140.00|   10995.00|                  0.00|
| 上期所 |        镍        |     ni1809     | 20180718|投          |   卖|      4|     108720.000|      109810.000|      109950.000|    -4920.00|    -560.00|   43980.00|                  0.00|
| 上期所 |        镍        |     ni1809     | 20180801|投          |   卖|      1|     113310.000|      109810.000|      109950.000|     3360.00|    -140.00|   10995.00|                  0.00|
| 上期所 |        镍        |     ni1809     | 20180801|投          |   卖|      1|     113310.000|      109810.000|      109950.000|     3360.00|    -140.00|   10995.00|                  0.00|
| 上期所 |        镍        |     ni1809     | 20180802|投          |   卖|      1|     111340.000|      109810.000|      109950.000|     1390.00|    -140.00|   10995.00|                  0.00|
| 上期所 |        镍        |     ni1809     | 20180802|投          |   卖|      3|     111320.000|      109810.000|      109950.000|     4110.00|    -420.00|   32985.00|                  0.00|
| 上期所 |        镍        |     ni1809     | 20180802|投          |   卖|      1|     111320.000|      109810.000|      109950.000|     1370.00|    -140.00|   10995.00|                  0.00|
| 上期所 |        镍        |     ni1809     | 20180802|投          |   卖|      1|     111320.000|      109810.000|      109950.000|     1370.00|    -140.00|   10995.00|                  0.00|
| 上期所 |        镍        |     ni1809     | 20180802|投          |   卖|      6|     111310.000|      109810.000|      109950.000|     8160.00|    -840.00|   65970.00|                  0.00|
| 上期所 |        镍        |     ni1809     | 20180802|投          |   卖|      3|     110210.000|      109810.000|      109950.000|      780.00|    -420.00|   32985.00|                  0.00|
| 上期所 |        镍        |     ni1809     | 20180802|投          |   卖|      2|     110200.000|      109810.000|      109950.000|      500.00|    -280.00|   21990.00|                  0.00|
| 上期所 |        镍        |     ni1809     | 20180802|投          |   卖|      1|     110200.000|      109810.000|      109950.000|      250.00|    -140.00|   10995.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180713|投          |   卖|      3|      48820.000|       49210.000|       49380.000|    -8400.00|   -2550.00|   74070.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180713|投          |   卖|      1|      48820.000|       49210.000|       49380.000|    -2800.00|    -850.00|   24690.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180713|投          |   卖|      4|      48690.000|       49210.000|       49380.000|   -13800.00|   -3400.00|   98760.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180720|投          |   卖|      1|      48260.000|       49210.000|       49380.000|    -5600.00|    -850.00|   24690.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180720|投          |   卖|      3|      48260.000|       49210.000|       49380.000|   -16800.00|   -2550.00|   74070.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180720|投          |   卖|      1|      48170.000|       49210.000|       49380.000|    -6050.00|    -850.00|   24690.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180720|投          |   卖|      1|      48170.000|       49210.000|       49380.000|    -6050.00|    -850.00|   24690.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180720|投          |   卖|      1|      48170.000|       49210.000|       49380.000|    -6050.00|    -850.00|   24690.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180720|投          |   卖|      1|      48170.000|       49210.000|       49380.000|    -6050.00|    -850.00|   24690.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180720|投          |   卖|      1|      48270.000|       49210.000|       49380.000|    -5550.00|    -850.00|   24690.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180720|投          |   卖|      3|      48270.000|       49210.000|       49380.000|   -16650.00|   -2550.00|   74070.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180730|投          |   卖|      4|      50060.000|       49210.000|       49380.000|    13600.00|   -3400.00|   98760.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180802|投          |   卖|      1|      49430.000|       49210.000|       49380.000|      250.00|    -850.00|   24690.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180802|投          |   卖|      1|      49430.000|       49210.000|       49380.000|      250.00|    -850.00|   24690.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180802|投          |   卖|      2|      49430.000|       49210.000|       49380.000|      500.00|   -1700.00|   49380.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180802|投          |   卖|      1|      49410.000|       49210.000|       49380.000|      150.00|    -850.00|   24690.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180802|投          |   卖|      1|      49410.000|       49210.000|       49380.000|      150.00|    -850.00|   24690.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180802|投          |   卖|      1|      49410.000|       49210.000|       49380.000|      150.00|    -850.00|   24690.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180802|投          |   卖|      1|      49410.000|       49210.000|       49380.000|      150.00|    -850.00|   24690.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180802|投          |   卖|      4|      49300.000|       49210.000|       49380.000|    -1600.00|   -3400.00|   98760.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180802|投          |   卖|      1|      49140.000|       49210.000|       49380.000|    -1200.00|    -850.00|   24690.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180802|投          |   卖|      1|      49140.000|       49210.000|       49380.000|    -1200.00|    -850.00|   24690.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180802|投          |   卖|      1|      49140.000|       49210.000|       49380.000|    -1200.00|    -850.00|   24690.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180802|投          |   卖|      1|      49140.000|       49210.000|       49380.000|    -1200.00|    -850.00|   24690.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180802|投          |   卖|      1|      49210.000|       49210.000|       49380.000|     -850.00|    -850.00|   24690.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180802|投          |   卖|      3|      49210.000|       49210.000|       49380.000|    -2550.00|   -2550.00|   74070.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180803|投          |   卖|      4|      49240.000|       49210.000|       49380.000|    -2800.00|   -3400.00|   98760.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180803|投          |   卖|      2|      49090.000|       49210.000|       49380.000|    -2900.00|   -1700.00|   49380.00|                  0.00|
| 上期所 |        铜        |     cu1809     | 20180803|投          |   卖|      2|      49090.000|       49210.000|       49380.000|    -2900.00|   -1700.00|   49380.00|                  0.00|
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
|共  95条|                  |                |         |            |     |    171|               |                |                |   -42655.00|  -45115.00| 2564323.15|                  0.00|
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
能源中心---INE  上期所---SHFE   中金所---CFFEX  大商所---DCE   郑商所---CZCE
买---Buy   卖---Sell  
投---Speculation  保---Hedge  套---Arbitrage 般---General

                                                         持仓汇总 Positions
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
|       品种       |      合约      |    买持     |    买均价   |     卖持     |    卖均价    |  昨结算  |  今结算  |持仓盯市盈亏|  保证金占用   |  投/保     |   多头期权市值   |   空头期权市值    |
|      Product     |   Instrument   |  Long Pos.  |Avg Buy Price|  Short Pos.  |Avg Sell Price|Prev. Sttl|Sttl Today|  MTM P/L   |Margin Occupied|    S/H     |Market Value(Long)|Market Value(Short)|
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
|      黄玉米      |     c1901      |            6|     1858.333|             1|      1844.000|  1849.000|  1864.000|      750.00|        7828.80|投          |              0.00|               0.00|
|       鸡蛋       |     jd1901     |            2|     3745.500|             2|      3791.000|  3749.000|  3769.000|        0.00|        6030.40|投          |              0.00|               0.00|
|     聚氯乙烯     |     v1901      |            0|        0.000|             5|      7092.000|  7105.000|  7120.000|     -700.00|           0.00|投          |              0.00|               0.00|
|     聚氯乙烯     |     v1809      |            5|     7146.000|             0|         0.000|  7180.000|  7185.000|      975.00|       12573.75|投          |              0.00|               0.00|
|       黄金       |     au1812     |           62|      269.894|             0|         0.000|   270.400|   270.450|     3100.00|      838395.00|投          |              0.00|               0.00|
|        镍        |     ni1809     |            0|        0.000|            36|    110465.833|109810.000|109950.000|    -5040.00|      395820.00|投          |              0.00|               0.00|
|        铜        |     cu1809     |            0|        0.000|            52|     49006.923| 49210.000| 49380.000|   -44200.00|     1283880.00|投          |              0.00|               0.00|
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
|共     7条        |                |           75|             |            96|              |          |          |   -45115.00|     2544527.95|            |              0.00|               0.00|
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------




";
        #endregion


        [ImportingConstructor]
        public PositionDailyVerifyPageCtrl(
            PositionDailyVerifyPageModel contentVM,
            ILoginDataService loginDataService,
            IContractItemTreeQueryController contractItemTreeQueryController,
            SettlementBillsCompareViewCtrl settlementBillsCompareViewCtrl,
            XqTradeItemsCompareViewCtrl xqTradeItemsCompareViewCtrl,
            PositionVerifyTradeInputAreaViewCtrl tradeInputAreaViewCtrl,
            ExportFactory<UpdateDailyPositionVerifyStatusDialogCtrl> verifyStatusDialogCtrlFactory)
        {
            this.contentVM = contentVM;
            this.loginDataService = loginDataService;
            this.contractItemTreeQueryController = contractItemTreeQueryController;
            this.settlementBillsCompareViewCtrl = settlementBillsCompareViewCtrl;
            this.xqTradeItemsCompareViewCtrl = xqTradeItemsCompareViewCtrl;
            this.tradeInputAreaViewCtrl = tradeInputAreaViewCtrl;
            this.verifyStatusDialogCtrlFactory = verifyStatusDialogCtrlFactory;

            pageGoBackCmd = new DelegateCommand(() => this.PageGoBackHandler?.Invoke(this));
            toUpdateVerifyStatusCmd = new DelegateCommand(ToUpdateVerifyStatus);
        }

        /// <summary>
        /// 当日持仓对比项
        /// </summary>
        public DailyPositionDifference DailyDiff { get; set; }

        /// <summary>
        /// 页面后退处理
        /// </summary>
        public Action<PositionDailyVerifyPageCtrl> PageGoBackHandler { get; set; }

        public object ContentView => contentVM.View;

        public void Initialize()
        {
            if (DailyDiff == null) throw new ArgumentNullException("DailyDiff");
            contentVM.DailyDiff = DailyDiff;
            var contractContainer = new TargetContract_TargetContractDetail((int)DailyDiff.SledContractId);
            XueQiaoFoundationHelper.SetupTargetContract_ContractDetail(contractContainer, 
                contractItemTreeQueryController, XqContractNameFormatType.CommodityAcronym_Code_ContractCode);
            contentVM.ContractDetailContainer = contractContainer;
            contentVM.PageGoBackCmd = pageGoBackCmd;
            contentVM.ToUpdateVerifyStatusCmd = toUpdateVerifyStatusCmd;

            settlementCompareItem.ContractDetailContainer = contractContainer;
        }

        public void Run()
        {
            // config settlementBillsCompareViewCtrl
            settlementBillsCompareViewCtrl.TradeAccountId = this.DailyDiff.TradeAccountId;
            settlementBillsCompareViewCtrl.SettlementCompareItem = this.settlementCompareItem;
            settlementBillsCompareViewCtrl.SettlementContentQueried = this.SettlementContentQueried;
            settlementBillsCompareViewCtrl.Initialize();
            settlementBillsCompareViewCtrl.Run();

            // config xqTradeItemsCompareViewCtrl
            xqTradeItemsCompareViewCtrl.TradeAccountId = this.DailyDiff.TradeAccountId;
            xqTradeItemsCompareViewCtrl.ContractId = (int)this.DailyDiff.SledContractId;
            xqTradeItemsCompareViewCtrl.SettlementCompareItem = this.settlementCompareItem;
            xqTradeItemsCompareViewCtrl.Initialize();
            xqTradeItemsCompareViewCtrl.Run();

            // config tradeInputAreaViewCtrl
            tradeInputAreaViewCtrl.DailyDiff = this.DailyDiff;
            tradeInputAreaViewCtrl.Initialize();
            tradeInputAreaViewCtrl.Run();

            contentVM.UpsideSettlementReferenceView = settlementBillsCompareViewCtrl.ContentView;
            contentVM.SledTradeRecordReferenceView = xqTradeItemsCompareViewCtrl.ContentView;
            contentVM.SledTradeInputView = tradeInputAreaViewCtrl.ContentView;
        }

        public void Shutdown()
        {
            PageGoBackHandler = null;
            settlementBillsCompareViewCtrl?.Shutdown();
            xqTradeItemsCompareViewCtrl?.Shutdown();
            tradeInputAreaViewCtrl?.Shutdown();
        }

        private void ToUpdateVerifyStatus()
        {
            var dialogCtrl = verifyStatusDialogCtrlFactory.CreateExport().Value;
            dialogCtrl.DialogOwner = UIHelper.GetWindowOfUIElement(contentVM.View);
            dialogCtrl.UpdateSourceDiff = this.DailyDiff;

            dialogCtrl.Initialize();
            dialogCtrl.Run();
            dialogCtrl.Shutdown();

            if (dialogCtrl.IsSuccessUpdated == true)
            {
                RefreshDailyDiffItem();
            }
        }

        private void SettlementContentQueried(SettlementBillsCompareViewCtrl _ctrl, TradeAccountSettlementInfoWithRelatedTime queriedResult)
        {
            if (_ctrl.SettlementCompareItem != this.settlementCompareItem) return;

            var suggestXqTradeReqBeginTSMs = queriedResult?.ReqTime?.StartTimestampMs;
            var suggestXqTradeReqEndTSMs = queriedResult?.ReqTime?.EndTimestampMs;
            if (suggestXqTradeReqBeginTSMs > 0 && suggestXqTradeReqEndTSMs > 0)
            {
                suggestXqTradeReqEndTSMs = Math.Max(suggestXqTradeReqEndTSMs.Value, suggestXqTradeReqBeginTSMs.Value);
                this.settlementCompareItem.SelectedXqTradeDateBegin = DateHelper.UnixTimeStampMsToDateTime(suggestXqTradeReqBeginTSMs.Value).ToLocalTime();
                this.settlementCompareItem.SelectedXqTradeDateEnd = DateHelper.UnixTimeStampMsToDateTime(suggestXqTradeReqEndTSMs.Value).ToLocalTime();
                xqTradeItemsCompareViewCtrl?.RefreshViewData();
            }
        }

        /// <summary>
        /// 刷新当日持仓比对差异项
        /// </summary>
        private void RefreshDailyDiffItem()
        {
            var dailyDiffItem = this.DailyDiff;
            if (dailyDiffItem == null) return;

            var landingInfo = loginDataService.ProxyLoginResp?.HostingSession?.HostingSession2LandingInfo();
            if (landingInfo == null) return;

            var tradeAccountId = dailyDiffItem.TradeAccountId;
            var contractId = dailyDiffItem.SledContractId;
            var dateSec = dailyDiffItem.DateSec;
            var option = new ReqDailyPositionDifferenceOption
            {
                TradeAccountId = tradeAccountId,
                SledContractId = contractId,
                DateSec = dateSec
            };
            XqThriftLibConfigurationManager.SharedInstance.TradeHostingTerminalAoHttpStub.reqDailyPositionDifferenceAsync(landingInfo, option, new IndexedPageOption { PageIndex = 0, PageSize = 1 }, CancellationToken.None)
                .ContinueWith(t =>
                {
                    var resp = t.Result;
                    var queriedItem = resp?.CorrectResult?.Page.FirstOrDefault(i => i.TradeAccountId == tradeAccountId && i.SledContractId == contractId && i.DateSec == dateSec);
                    if (queriedItem == null) return;
                    DispatcherHelper.CheckBeginInvokeOnUI(() =>
                    {
                        // update dailyDiffItem
                        // 存在，改变内容
                        TBase refItem = dailyDiffItem;
                        ThriftHelper.UnserializeBytesToTBase(ref refItem, ThriftHelper.SerializeTBaseToBytes(queriedItem));
                    });
                });
        }
    }
}
