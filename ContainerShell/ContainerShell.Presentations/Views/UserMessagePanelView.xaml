<UserControl x:Class="ContainerShell.Presentations.Views.UserMessagePanelView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:controls="clr-namespace:XueQiaoFoundation.UI.Controls;assembly=XueQiaoFoundation.UI"
             xmlns:helper="clr-namespace:XueQiaoFoundation.Shared.Helper;assembly=XueQiaoFoundation.Shared"
             xmlns:uiextra_convert="clr-namespace:XueQiaoFoundation.UI.Extra.converter;assembly=XueQiaoFoundation.UI.Extra"
             xmlns:msg_model="clr-namespace:xueqiao.mailbox.user.message.thriftapi;assembly=IDLAutoGenerated"
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             xmlns:shell="clr-namespace:Microsoft.Windows.Shell;assembly=Microsoft.Windows.Shell"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800"
             x:Name="ViewRoot">
    <UserControl.Resources>
        <sys:Double x:Key="LeftColumnWidth">320.0</sys:Double>
        <uiextra_convert:Timestamp2StringConverter x:Key="MsgTime2Str" Convert2StringFormatType="DateTimeIgnoreYear" ValueType="Second"/>
        <DataTemplate x:Key="UserMessageListItemDT">
            <DockPanel LastChildFill="True">
                <Rectangle x:Name="MsgLevelRect" Fill="{x:Null}" Width="4" DockPanel.Dock="Left" VerticalAlignment="Stretch"/>
                <Rectangle x:Name="BottomBorderRect" Fill="{DynamicResource BorderBrush2}" Height="1" DockPanel.Dock="Bottom" HorizontalAlignment="Stretch"/>
                <StackPanel DockPanel.Dock="Right" Margin="8">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" Text="{Binding Title}"/>
                        <TextBlock Grid.Column="1" Margin="8,0,0,0" Text="未读" Foreground="{DynamicResource MinorBrush1}" FontSize="{DynamicResource SecondaryContentFontSize}"
                                   Visibility="Visible"
                                   x:Name="UnreadTipText"/>
                    </Grid>
                    <Grid Margin="0,8,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" Text="{Binding Summary}" Foreground="{DynamicResource ContentBrush3}" FontSize="{DynamicResource SecondaryContentFontSize}"
                                   VerticalAlignment="Bottom"/>
                        <TextBlock Grid.Column="1" Margin="8,0,0,0" Text="{Binding CreateTimestamp, Converter={StaticResource MsgTime2Str}}" Foreground="{DynamicResource ContentBrush3}" FontSize="{DynamicResource SecondaryContentFontSize}"
                                   VerticalAlignment="Bottom"/>
                    </Grid>
                </StackPanel>
            </DockPanel>
            <DataTemplate.Triggers>
                <DataTrigger Binding="{Binding Level}" Value="{x:Static msg_model:MLevel.LEVEL_HIGH}">
                    <Setter TargetName="MsgLevelRect" Property="Fill" Value="{DynamicResource MsgLevelHighBrush}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Level}" Value="{x:Static msg_model:MLevel.LEVEL_MEDIUM}">
                    <Setter TargetName="MsgLevelRect" Property="Fill" Value="{DynamicResource MsgLevelMediumBrush}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding State}" Value="{x:Static msg_model:MessageState.READ}">
                    <Setter TargetName="UnreadTipText" Property="Visibility" Value="Collapsed"/>
                </DataTrigger>
            </DataTemplate.Triggers>
        </DataTemplate>

        <DataTemplate x:Key="LoadMoreItemsViewDT">
            <Button x:Name="LoadMoreButton" 
                    Style="{StaticResource FlatContentButtonPrimary3}"
                    Command="{Binding ElementName=ViewRoot, Path=DataContext.LoadMoreItemsCmd}"
                    HorizontalAlignment="Center" VerticalAlignment="Center" Height="35"
                    Visibility="Visible"
                    Content="加载更多"/>
            <DataTemplate.Triggers>
                <DataTrigger Binding="{Binding ElementName=ViewRoot, Path=DataContext.IsLoadingMoreItems}" Value="True">
                    <Setter TargetName="LoadMoreButton" Property="Content" Value="正在加载更多..."/>
                </DataTrigger>
                <DataTrigger Binding="{Binding ElementName=ViewRoot, Path=DataContext.ShowLoadMoreButton}" Value="False">
                    <Setter TargetName="LoadMoreButton" Property="Visibility" Value="Collapsed"/>
                </DataTrigger>
            </DataTemplate.Triggers>
        </DataTemplate>
    </UserControl.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="{Binding Source={StaticResource LeftColumnWidth}}"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <controls:CustomHeaderedWindowHeader 
            Grid.Row="0" Grid.ColumnSpan="2"
            Style="{StaticResource CustomHeaderedWindowHeaderStyleDefault}"
            BorderThickness="0,0,0,1"
            BorderBrush="{DynamicResource BorderBrush2}"
            IsHideMinimizeWindowMenuButton="True"
            IsHideMaximizeWindowMenuButton="True"
            IsHideCloseWindowMenuButton="False"
            helper:WpfElementSizeObserver.Observe="True"
            helper:WpfElementSizeObserver.ObservedHeight="{Binding WindowCaptionHeightHolder.DialogCaptionHeight, Mode=OneWayToSource}"
            CloseWindowMenuButtonClickHandler="{Binding CloseMenuButtonClickHandler}"
            x:Name="WindowCaptionHeader">
            <DockPanel LastChildFill="False" Width="{Binding Source={StaticResource LeftColumnWidth}}" Margin="0,15,8,12">
                <Viewbox Width="18" Height="18" DockPanel.Dock="Left" Margin="10,0,0,0">
                    <Path Data="M847.189333 625.550222l4.892445-3.868444L1291.491556 1024H73.955556l432.355555-390.599111c72.704 58.026667 119.580444 87.836444 166.115556 87.836444 48.469333 0 97.052444-31.744 174.876444-95.687111z m-508.245333-106.154666c37.546667 29.013333 71.907556 55.296 103.879111 80.213333L1.365333 987.591111C1.137778 985.201778 0 983.381333 0 980.992V256c115.143111 90.794667 235.064889 183.409778 339.057778 263.395556z m1023.089778 468.081777L922.510222 579.470222A95377.635556 95377.635556 0 0 1 1365.333333 219.591111V970.524444a53.816889 53.816889 0 0 1-3.299555 16.839112zM1280 0c31.175111 0 85.333333 55.068444 85.333333 86.812444v38.115556a85639.168 85639.168 0 0 0-574.805333 457.045333c-124.245333 101.034667-124.245333 101.034667-245.987556 3.982223-45.169778-35.84-102.4-80.782222-166.229333-130.958223A32078.506667 32078.506667 0 0 1 0 155.079111v-68.266667C0 55.068444 54.158222 0 85.333333 0h1194.666667z"
                          Fill="{DynamicResource IconBrush1}"/>
                </Viewbox>
                <TextBlock Text="消息通知" FontSize="{DynamicResource RegularTitleFontSize}" FontWeight="DemiBold"
                           DockPanel.Dock="Left"
                           Margin="8,0,0,0"/>
                <Button Style="{StaticResource FlatContentButtonPrimary3}"
                        Command="{Binding RefreshItemsCmd}"
                        Content="刷新" Margin="10,0,4,-4" VerticalAlignment="Bottom"
                        shell:WindowChrome.IsHitTestVisibleInChrome="True"
                        DockPanel.Dock="Right"/>
            </DockPanel>
        </controls:CustomHeaderedWindowHeader>

        <ListBox Grid.Row="1" Grid.Column="0"
                 IsSynchronizedWithCurrentItem="True"
                 ItemsSource="{Binding MessageCollectionView}"
                 SelectedItem="{Binding SelectedMessageItem, Mode=TwoWay}"
                 ItemTemplate="{StaticResource UserMessageListItemDT}"
                 BorderThickness="0,0,1,0" BorderBrush="{DynamicResource BorderBrush2}"
                 ScrollViewer.VerticalScrollBarVisibility="Auto" 
                 ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                 OverridesDefaultStyle="True"
                 VirtualizingPanel.VirtualizationMode="Recycling">
            <ListBox.ItemContainerStyle>
                <Style BasedOn="{StaticResource ListBoxItemStyleDefault}" TargetType="{x:Type ListBoxItem}">
                    <Setter Property="Padding" Value="0"/>
                </Style>
            </ListBox.ItemContainerStyle>
            <ListBox.Template>
                <ControlTemplate TargetType="{x:Type ListBox}">
                    <Border BorderBrush="{TemplateBinding BorderBrush}"
                            BorderThickness="{TemplateBinding BorderThickness}"
                            SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}">
                        <ScrollViewer Padding="{TemplateBinding Padding}"
                                      CanContentScroll="{TemplateBinding ScrollViewer.CanContentScroll}"
                                      Focusable="False"
                                      HorizontalScrollBarVisibility="{TemplateBinding ScrollViewer.HorizontalScrollBarVisibility}"
                                      SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"
                                      VerticalScrollBarVisibility="{TemplateBinding ScrollViewer.VerticalScrollBarVisibility}"
                                      Style="{StaticResource ScrollViewerDefault}">
                            <DockPanel LastChildFill="True">
                                <ContentControl DockPanel.Dock="Bottom" ContentTemplate="{StaticResource LoadMoreItemsViewDT}"/>
                                <ItemsPresenter DockPanel.Dock="Top" SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}" />
                            </DockPanel>
                        </ScrollViewer>
                    </Border>
                    <ControlTemplate.Triggers>
                        <Trigger Property="IsGrouping" Value="false">
                            <Setter Property="ScrollViewer.CanContentScroll" Value="false" />
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </ListBox.Template>
        </ListBox>
        <ContentControl Grid.Row="1" Grid.Column="1" Content="{Binding SelectedMessageContentView}"/>
    </Grid>
</UserControl>
